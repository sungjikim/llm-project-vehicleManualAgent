"""
설정 및 상수 정의
"""

import os
from pathlib import Path
from dotenv import load_dotenv

# 환경 변수 로드
load_dotenv()

# 프로젝트 경로
PROJECT_ROOT = Path(__file__).parent.parent.parent
DATA_DIR = PROJECT_ROOT / "data"
CHROMA_DB_DIR = PROJECT_ROOT / "chroma_db"

# PDF 파일 경로
DEFAULT_PDF_PATH = DATA_DIR / "backup" / "kr_ko-KR_xc60_2026.pdf"

# 모델 설정
DEFAULT_LLM_MODEL = "gpt-4o-mini"
DEFAULT_LLM_TEMPERATURE = 0
DEFAULT_EMBEDDING_MODEL = "text-embedding-3-small"

# Cross-Encoder 모델
CROSS_ENCODER_MODEL = "BAAI/bge-reranker-v2-m3"

# 검색 설정
DEFAULT_TOP_K = 5
CANDIDATE_DOCS_COUNT = 20  # 재순위화를 위한 후보 문서 수
CHUNK_SIZE = 300
CHUNK_OVERLAP = 30
BATCH_SIZE = 50

# 압축 설정
SIMILARITY_THRESHOLD = 0.6  # 임베딩 필터링 임계값
REDUNDANCY_THRESHOLD = 0.9  # 중복 제거 임계값

# 검색 전략 옵션
SEARCH_OPTIONS = {
    "vector_only": "벡터 검색만 사용",
    "bm25_only": "BM25 키워드 검색만 사용", 
    "hybrid_balanced": "하이브리드 (5:5)",
    "hybrid_semantic": "하이브리드 (7:3 - 의미론적 우선)",
    "hybrid_keyword": "하이브리드 (3:7 - 키워드 우선)",
    "multi_query": "다중 쿼리 생성 검색",
    "expanded_query": "전문 용어 확장 검색",
    "cross_encoder_rerank": "Cross-Encoder 재순위화 검색",
    "contextual_compression": "맥락 압축 검색"
}

# 하이브리드 검색 가중치 설정
WEIGHT_CONFIGS = {
    "hybrid_semantic": 0.7,    # 의미론적 검색 우선
    "hybrid_balanced": 0.5,    # 균형 검색
    "hybrid_keyword": 0.3      # 키워드 검색 우선
}

# 차량 전문 용어 매핑
VEHICLE_TERMS = {
    '타이어': ['타이어', '타이어 압력', '공기압', '압력', 'PSI', 'bar', '휠', '바퀴'],
    '브레이크': ['브레이크', '제동', '제동장치', '브레이크 패드', '제동 패드', '브레이크액', '제동액'],
    '엔진': ['엔진', '모터', '동력장치', '엔진오일', '오일', '윤활유', '냉각수'],
    '경고등': ['경고등', '표시등', '인디케이터', '알림등', '경고 신호', '계기판', '대시보드'],
    '문제': ['문제', '고장', '오류', '이상', '결함', '오작동', '트러블', '장애'],
    '교체': ['교체', '교체방법', '바꾸기', '수리', '정비', '유지보수', '점검', '관리'],
    '연료': ['연료', '연료탱크', '기름', '가솔린', '디젤', '연비', '주유'],
    '배터리': ['배터리', '축전지', '전기', '충전', '방전', '전원'],
    'XC60': ['XC60', '볼보', 'VOLVO', '차량', '모델', '사양'],
    '주차': ['주차', '파킹', '자동주차', '주차보조', '주차센서'],
    '시동': ['시동', '엔진시동', '시동걸기', '점화', '스타트'],
    '사륜구동': ['사륜구동', '4WD', 'AWD', '전륜구동', '후륜구동', '구동방식']
}

# Kiwi 토크나이저 사용자 정의 단어
CUSTOM_WORDS = [
    ('볼보', 'NNP'),
    ('XC60', 'NNP'), 
    ('타이어', 'NNG'),
    ('브레이크', 'NNG'),
    ('엔진', 'NNG'),
    ('경고등', 'NNG')
]

# Few-shot 예시 데이터 (상용 수준 8개 예시)
VEHICLE_EXAMPLES = [
    # 1. 정비/유지보수 관련 (일반적 질문)
    {
        "query": "오일 교체는 언제 해야 하나요?",
        "context": "엔진 오일은 주행 거리에 따라 교체 주기가 달라집니다. 일반적으로 10,000km 또는 12개월마다 교체하는 것이 권장됩니다. 오일 교체는 볼보 공식 서비스 센터에서 실시하는 것이 좋습니다. [페이지 326-327]",
        "answer": "엔진 오일은 주행 거리 10,000km 또는 12개월마다 교체하는 것이 권장됩니다. 정확한 교체 시기는 주행 환경과 운전 습관에 따라 달라질 수 있으니, 볼보 공식 서비스 센터에서 점검받으시기 바랍니다.\n\n⚠️ **안전상 주의사항**: 오일 레벨을 정기적으로 확인하시기 바랍니다.\n\n📚 참고 페이지: 326-327"
    },
    # 2. 문제 해결/트러블슈팅 (긴급 상황)
    {
        "query": "브레이크가 제대로 작동하지 않는 것 같아요.",
        "context": "브레이크 시스템에 문제가 생겼을 때는 즉시 주행을 중단하고 안전한 장소에 주차해야 합니다. 브레이크 패드의 마모나 브레이크 액체 부족이 원인일 수 있습니다. 브레이크 경고등이 켜져 있는지 확인하세요. [페이지 195-196]",
        "answer": "브레이크 시스템에 이상이 있을 때는 **즉시 안전한 장소에 주차**하고 주행을 중단하세요.\n\n**확인 사항**:\n1. 브레이크 경고등 점등 여부\n2. 브레이크 페달의 느낌 변화\n3. 브레이크 액체 레벨\n\n이러한 증상들은 브레이크 패드 마모나 브레이크 액체 부족을 나타낼 수 있습니다.\n\n⚠️ **안전상 주의사항**: 즉시 볼보 공식 서비스 센터에 연락하여 점검을 받으시기 바랍니다.\n\n📚 참고 페이지: 195-196"
    },
    # 3. 이상 소음/진동 (진단 질문)
    {
        "query": "타이어 소음이 이상해요.",
        "context": "타이어에서 비정상적인 소음이 나는 경우 여러 원인이 있을 수 있습니다. 타이어 공기압 부족, 타이어 마모, 이물질 끼임 등이 주요 원인입니다. 타이어 공기압을 정기적으로 확인하고, 타이어 표면에 손상이 없는지 검사하세요. [페이지 316-321]",
        "answer": "타이어에서 비정상적인 소음이 나는 경우 다음 사항들을 확인해주세요:\n\n**점검 순서**:\n1. **타이어 공기압 확인**: 권장 압력에 맞게 조정\n2. **타이어 표면 검사**: 균열, 손상, 이물질 끼임 여부 확인\n3. **타이어 마모도 점검**: 트레드 깊이 확인\n\n이러한 문제들은 주행 안전에 직접적인 영향을 미칠 수 있습니다.\n\n⚠️ **안전상 주의사항**: 소음이 지속되거나 악화될 경우 즉시 전문가의 점검을 받으시기 바랍니다.\n\n📚 참고 페이지: 316-321"
    },
    # 4. 구체적 사양/수치 질문
    {
        "query": "XC60의 연료 탱크 용량은 얼마인가요?",
        "context": "볼보 XC60의 연료 탱크 용량은 68리터입니다. 연료 게이지가 1/4 이하로 떨어지면 주유를 권장합니다. 연료 부족 경고등이 켜지면 약 50km 주행이 가능합니다. [페이지 89]",
        "answer": "볼보 XC60의 연료 탱크 용량은 **68리터**입니다.\n\n**연료 관리 팁**:\n- 연료 게이지가 1/4 이하일 때 주유 권장\n- 연료 부족 경고등 점등 시 약 50km 주행 가능\n- 정기적인 연료 상태 확인으로 안전한 주행 유지\n\n⚠️ **안전상 주의사항**: 연료 부족 상태에서의 장거리 주행은 피하시기 바랍니다.\n\n📚 참고 페이지: 89"
    },
    # 5. 기능 사용법 (How-to 질문)
    {
        "query": "자동 주차 기능은 어떻게 사용하나요?",
        "context": "자동 주차 기능(Park Assist Pilot)을 사용하려면 먼저 주차 공간을 찾아야 합니다. 시속 30km 이하로 주행하며 주차 공간을 스캔합니다. 적절한 공간이 감지되면 화면에 알림이 표시됩니다. 기어를 후진으로 넣고 지시에 따라 브레이크와 가속을 조작하세요. [페이지 142-145]",
        "answer": "자동 주차 기능(Park Assist Pilot) 사용 방법:\n\n**사용 절차**:\n1. **주차 공간 탐색**: 시속 30km 이하로 주행하며 공간 스캔\n2. **공간 감지**: 화면에 적절한 주차 공간 알림 표시\n3. **후진 기어**: 기어를 R(후진)으로 변경\n4. **자동 조향**: 시스템이 자동으로 핸들 조작\n5. **수동 조작**: 브레이크와 가속 페달은 운전자가 직접 조작\n\n⚠️ **안전상 주의사항**: 주차 중에는 항상 주변 상황을 주의 깊게 확인하시기 바랍니다.\n\n📚 참고 페이지: 142-145"
    },
    # 6. 경고등/표시등 (시각적 신호 해석)
    {
        "query": "계기판에 노란색 삼각형 경고등이 켜졌어요.",
        "context": "노란색 삼각형 경고등은 일반적인 주의 경고등입니다. 차량에 경미한 문제가 발생했음을 나타냅니다. 즉시 주행을 중단할 필요는 없지만 가능한 빨리 점검을 받아야 합니다. 구체적인 문제는 인포테인먼트 화면에서 확인할 수 있습니다. [페이지 67-68]",
        "answer": "노란색 삼각형 경고등은 **일반 주의 경고등**입니다.\n\n**의미 및 대응**:\n- 차량에 경미한 문제 발생을 알림\n- 즉시 주행 중단 필요 없음\n- 가능한 빨리 점검 권장\n\n**확인 방법**:\n1. 인포테인먼트 화면에서 구체적 문제 확인\n2. 차량 매뉴얼에서 해당 경고등 의미 확인\n3. 문제가 지속되면 서비스 센터 방문\n\n⚠️ **안전상 주의사항**: 경고등이 빨간색으로 변하거나 다른 증상이 나타나면 즉시 안전한 곳에 정차하세요.\n\n📚 참고 페이지: 67-68"
    },
    # 7. 계절별/환경별 관리 (예방 관리)
    {
        "query": "겨울철 차량 관리는 어떻게 해야 하나요?",
        "context": "겨울철에는 배터리 성능이 저하되고 타이어 공기압이 낮아질 수 있습니다. 겨울용 타이어 교체, 부동액 점검, 와이퍼 블레이드 상태 확인이 필요합니다. 눈길 주행 시에는 사륜구동 모드를 활용하세요. [페이지 278-282]",
        "answer": "겨울철 차량 관리 체크리스트:\n\n**필수 점검 사항**:\n1. **타이어**: 겨울용 타이어 교체 및 공기압 확인\n2. **배터리**: 성능 저하 대비 점검 및 교체\n3. **부동액**: 농도 및 레벨 확인\n4. **와이퍼**: 블레이드 상태 점검 및 겨울용 교체\n5. **사륜구동**: 눈길 주행 시 AWD 모드 활용\n\n**추가 권장사항**:\n- 비상용품 준비 (체인, 삽, 담요 등)\n- 연료 탱크 절반 이상 유지\n- 정기적인 세차로 염분 제거\n\n⚠️ **안전상 주의사항**: 겨울철 주행 전 충분한 예열과 안전거리 확보가 중요합니다.\n\n📚 참고 페이지: 278-282"
    },
    # 8. 복잡한 시스템 설명 (기술적 질문)
    {
        "query": "사륜구동 시스템은 어떻게 작동하나요?",
        "context": "볼보의 AWD(All-Wheel Drive) 시스템은 전자제어식으로 도로 상황에 따라 자동으로 전후륜 토크를 분배합니다. 일반적으로 앞바퀴 95%, 뒷바퀴 5%로 동력을 분배하다가 미끄러짐이 감지되면 최대 50:50까지 조정됩니다. 험로나 눈길에서는 수동으로 AWD 모드를 선택할 수 있습니다. [페이지 156-159]",
        "answer": "볼보 AWD(All-Wheel Drive) 시스템 작동 원리:\n\n**기본 동력 분배**:\n- 평상시: 전륜 95%, 후륜 5%\n- 미끄러짐 감지 시: 최대 50:50까지 자동 조정\n\n**작동 방식**:\n1. **전자제어**: 도로 상황을 실시간 모니터링\n2. **자동 분배**: 바퀴 미끄러짐 감지 시 즉시 토크 재분배\n3. **수동 선택**: 험로/눈길에서 AWD 모드 수동 활성화\n\n**주요 장점**:\n- 향상된 접지력과 안정성\n- 다양한 노면 조건 대응\n- 연료 효율성과 성능의 균형\n\n⚠️ **안전상 주의사항**: AWD 시스템이 있어도 안전 운전 수칙을 반드시 준수하시기 바랍니다.\n\n📚 참고 페이지: 156-159"
    }
]
